/*! BP-Reactions - v1.0.1 - 2016-06-09 4:03:58 PM UTC - https://github.com/imath/bp-reactions/ */
window.wp=window.wp||{},window.bpReactions=window.bpReactions||{},function(a,b){"undefined"!=typeof BP_Reaction_Migrate&&(_.extend(bpReactions,_.pick(wp,"Backbone","ajax","template")),bpReactions.Models=bpReactions.Models||{},bpReactions.Collections=bpReactions.Collections||{},bpReactions.Views=bpReactions.Views||{},bpReactions.Tool={start:function(){this.tasks=new bpReactions.Collections.Tasks,this.step=0,this.completed=!1;var a=new bpReactions.Views.Migrator({collection:this.tasks});a.inject("#bp-reactions-migrates"),this.setUpTasks()},setUpTasks:function(){var a=this;_.each(b("#bp-reactions-migrate input[type=checkbox]:checked"),function(c,d){a.tasks.add({id:b(c).prop("id"),order:d,message:b(c).data("message"),count:b(c).val(),number:b(c).data("number"),done:0,active:!1})})}},bpReactions.Collections.Tasks=Backbone.Collection.extend({proceed:function(a){return a=a||{},a.context=this,a.data=a.data||{},a.data=_.extend(a.data,{action:"bp_reactions_migrate",nonce:BP_Reaction_Migrate.nonce}),bpReactions.ajax.send(a)}}),bpReactions.View=bpReactions.Backbone.View.extend({inject:function(a){this.render(),b(a).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bpReactions.Views.Migrator=bpReactions.View.extend({tagName:"div",initialize:function(){this.views.add(new bpReactions.View({tagName:"ul",id:"bp-reactions-migrate-tasks"})),this.collection.on("add",this.injectTask,this),this.collection.on("change:active",this.manageQueue,this),this.collection.on("change:done",this.manageQueue,this)},taskSuccess:function(a){var c,d,e;a.done&&a.callback&&(c=this.get(a.callback),c.set("done",Number(a.done)+Number(c.get("done"))),bpReactions.Tool.step+=Number(c.get("number")),Number(c.get("count"))===Number(c.get("done"))&&(b("#"+a.callback+" .bp-reactions-progress").html(BP_Reaction_Migrate.success).addClass("updated"),c.set("active",!1),bpReactions.Tool.step=0,d=Number(c.get("order"))+1,e=this.findWhere({order:d}),_.isObject(e)&&e.set("active",!0)))},taskError:function(a){a.message&&a.callback&&b("#"+a.callback+" .bp-reactions-progress").html(a.message).addClass(a.type)},injectTask:function(a){this.views.add("#bp-reactions-migrate-tasks",new bpReactions.Views.Task({model:a}))},manageQueue:function(a){!0===a.get("active")&&this.collection.proceed({data:_.extend(_.pick(a.attributes,["id","count","number","done"]),{step:bpReactions.Tool.step}),success:this.taskSuccess,error:this.taskError})}}),bpReactions.Views.Task=bpReactions.View.extend({tagName:"li",template:bpReactions.template("progress-window"),className:"bp-reactions-migrate-task",initialize:function(){this.model.on("change:done",this.taskProgress,this),this.model.on("change:active",this.addClass,this),0===this.model.get("order")&&this.model.set("active",!0)},addClass:function(a){!0===a.get("active")&&b(this.$el).addClass("active")},taskProgress:function(a){if(!_.isUndefined(a.get("done"))&&!_.isUndefined(a.get("count"))){var c=Number(a.get("done"))/Number(a.get("count"))*100;b("#"+a.get("id")+" .bp-reactions-progress .bp-reactions-bar").css("width",c+"%")}}}),b("#bp-reactions-migrate-submit").on("click",function(a){return a.preventDefault(),b("#bp-reactions-migrate input[type=checkbox]:checked").length?void bpReactions.Tool.start():void window.alert(BP_Reaction_Migrate.notask)}))}(bpReactions,jQuery);